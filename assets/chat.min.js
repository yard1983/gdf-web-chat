var me={avatar:"http://virtualproductions.co.za/wp-content/uploads/2018/04/user_image.jpg"},bot={avatar:"https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRmYPWnjPHbtWJ7ii5zqc3Xf9K1vx8K3jbnP_VtGNE2N5LyFiWHTQ&s"},chatConfig={organizationId:"2789fc30-6e86-42f2-a8ad-b153f994590a",deploymentId:"47244ccb-18d7-4392-96b5-e79be24b372f",routingTarget:{targetType:"QUEUE",targetAddress:"Andina_JL"},memberInfo:{displayName:"Customer",profileImageUrl:me.avatar,customFields:{firstName:"Customer",lastName:""}}};const PARTICIPANT_TYPE={BOT:"Bot",AGENT:"Agente"};var token="",conversationId="",agentMemberId="",customerMemberId="",currentParticipant=PARTICIPANT_TYPE.BOT,chatbotHistory="",displayName="Customer",botName="Bot",chatbotHistorySent=!1,surveyURI="survey.html";function formatAMPM(e){var t=e.getHours(),a=e.getMinutes(),n=t>=12?"PM":"AM";return(t=(t%=12)||12)+":"+(a=a<10?"0"+a:a)+" "+n}function insertChat(e,t,a){void 0===a&&(a=0);var n="",o=formatAMPM(new Date);"me"==e?(n='<span class="rn_MessagePost"><img alt="" src="https://davivienda.custhelp.com/euf/generated/optimized/1571414603/themes/davivienda/images/chatEndUserMessage.png"><span class="rn_UserTextPrefix">'+displayName+"</span>: "+t+'<div class="rn_TimeCustom">'+o+"</div><br></span>",currentParticipant==PARTICIPANT_TYPE.BOT&&(chatbotHistory+=displayName+": "+t+"\n")):(n='<span class="rn_MessagePost"><img alt="" src="https://davivienda.custhelp.com/euf/generated/optimized/1571414603/themes/davivienda/images/chatAgent.png"><span class="rn_UserTextPrefix">'+currentParticipant+"</span>: "+t+'<div class="rn_TimeCustom">'+o+"</div><br></span>",currentParticipant==PARTICIPANT_TYPE.BOT&&(chatbotHistory+=botName+": "+t+"\n")),setTimeout(function(){$("#chatTranscript").append(n).scrollTop($("#chatTranscript").prop("scrollHeight"))},a)}function resetChat(){$("#chatTranscript").empty()}function disableChat(){printMessage("Chat finalizado"),$("#mytext").prop("disabled",!0),$("#endChat").prop("disabled",!0)}function createChatPurecloud(){$.ajax({type:"POST",url:"https://api.mypurecloud.com/api/v2/webchat/guest/conversations",data:JSON.stringify(chatConfig),contentType:"application/json",dataType:"json",success:function(e){console.log(e),token=e.jwt,conversationId=e.id;let t=new WebSocket(e.eventStreamUri);t.onopen=function(e){console.log("Connection established"),printMessage("Conectando con agente..."),$("#mytext").prop("readonly",!0)},t.onmessage=function(e){console.log(e.data,"event.data");let a=JSON.parse(e.data);console.log(a,"message"),a&&a.eventBody&&("standard"==a.eventBody.bodyType&&a.eventBody.sender&&a.eventBody.sender.id==agentMemberId?insertChat("bot",a.eventBody.body,0):"member-join"==a.eventBody.bodyType&&getConversationMembers(),a.eventBody.member&&(a.eventBody.member.id==agentMemberId&&"DISCONNECTED"==a.eventBody.member.state||a.eventBody.member.id==customerMemberId&&"DISCONNECTED"==a.eventBody.member.state)&&(t.close(),disableChat(),surveyURI&&(window.location.href=$(location).attr("origin")+"/"+surveyURI)))}}})}function printMessage(e){let t='<span class="rn_MessagePost"><img alt="" src="https://davivienda.custhelp.com/euf/generated/optimized/1571414603/themes/davivienda/images/chatAlert.png">'+e+"<br></span>";$("#chatTranscript").append(t).scrollTop($("#chatTranscript").prop("scrollHeight"))}function getConversationMembers(){let e="https://api.mypurecloud.com/api/v2/webchat/guest/conversations/"+conversationId+"/members";$.ajax({type:"GET",url:e,contentType:"application/json",dataType:"json",headers:{Authorization:"Bearer "+token},success:function(e){console.log(e,"members"),e.entities&&$.each(e.entities,function(e,t){"CUSTOMER"==t.role?(customerMemberId=t.id,chatbotHistorySent||(sendMessageToPurecloud("--- bot history ---\n"+chatbotHistory+"--- bot history ---\n"),chatbotHistorySent=!0)):"AGENT"==t.role&&(agentMemberId=t.id,currentParticipant=PARTICIPANT_TYPE.AGENT,$("#mytext").prop("readonly",!1))})}})}function endConversation(){console.log("customerMemberId: "+customerMemberId,"endConversation");let e="https://api.mypurecloud.com/api/v2/webchat/guest/conversations/"+conversationId+"/members/"+customerMemberId;customerMemberId&&$.ajax({type:"DELETE",url:e,contentType:"application/json",dataType:"json",headers:{Authorization:"Bearer "+token},success:function(e){console.log(e,"Chat finalizado")}})}function sendMessageToBot(e,t="standard"){let a={query:e};$.ajax({type:"POST",url:"http://gdf-gateway-git-gdf-gateway.apps.us-west-1.starter.openshift-online.com/gdf/intent",data:JSON.stringify(a),contentType:"application/json",dataType:"json",success:function(e){console.log(e),e.confidence<=.5||e.query&&e.intent.toLowerCase().includes("agente")?createChatPurecloud():insertChat("bot",e.response)}})}function sendMessageToPurecloud(e,t="standard"){let a="https://api.mypurecloud.com/api/v2/webchat/guest/conversations/"+conversationId+"/members/"+customerMemberId+"/messages",n={body:e,bodyType:t};$.ajax({type:"POST",url:a,data:JSON.stringify(n),contentType:"application/json",dataType:"json",headers:{Authorization:"Bearer "+token},success:function(e){console.log(e,"sendMessagePurecloud")}})}$(document).ready(function(){$("#sendButton").click(function(e){var t=$("#mytext").val();""!==t&&(insertChat("me",t),$("#mytext").val(""),currentParticipant==PARTICIPANT_TYPE.AGENT?sendMessageToPurecloud(t):currentParticipant==PARTICIPANT_TYPE.BOT&&sendMessageToBot(t))}),$("#endChat").click(function(e){console.log("currentParticipant: "+currentParticipant,"endChat"),currentParticipant!=PARTICIPANT_TYPE.BOT?endConversation():disableChat()}),$("#mytext").keydown(function(e){if(13==e.which){var t=$(this).val();""!==t&&(insertChat("me",t),$(this).val(""),currentParticipant==PARTICIPANT_TYPE.AGENT?sendMessageToPurecloud(t):currentParticipant==PARTICIPANT_TYPE.BOT&&sendMessageToBot(t))}})}),resetChat(),insertChat("bot","Hola, soy un asistente virtual, ¿En qué puedo ayudarte?",0);